<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inner Garden | NN's Life OS</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sage: {
                            50: '#f4f7f4',
                            100: '#e3ebe3',
                            200: '#c5d8c5',
                            300: '#9bb99b',
                            400: '#769c76',
                            500: '#588158', 
                            600: '#436643',
                        },
                        stone: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f2f4f2; 
            color: #57534e; 
            overscroll-behavior-y: none;
            font-size: 16px; 
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            transition: transform 0.2s ease, box-shadow 0.2s ease; /* Removed 'all' to avoid conflict with drag */
        }
        
        /* Disable hover effect while dragging */
        body:not(.dragging) .glass-card:hover {
            background: rgba(255, 255, 255, 0.85);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }

        /* Dragging styles */
        .sortable-ghost {
            opacity: 0.4;
            background: #e7e5e4;
        }
        .sortable-drag {
            cursor: grabbing;
            opacity: 1;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transform: scale(1.02);
        }
        .drag-handle {
            cursor: grab;
            touch-action: none; /* Prevent scroll on mobile while dragging */
        }
        .drag-handle:active {
            cursor: grabbing;
        }

        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #a8a29e;
            cursor: pointer;
            margin-top: -7px; 
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e7e5e4;
            border-radius: 2px;
        }

        @keyframes floatPoints {
            0% { opacity: 0; transform: translateY(5px); }
            20% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .point-float {
            position: absolute;
            color: #d97706; /* amber-600 for floating text */
            font-weight: 600;
            font-size: 1.2rem;
            pointer-events: none;
            z-index: 50;
            animation: floatPoints 1.2s ease-out forwards;
            font-family: 'Courier New', Courier, monospace; 
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.8);
        }

        /* NEW: Gold Flash Animation */
        @keyframes goldPulse {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.25); filter: brightness(1.2) drop-shadow(0 0 8px rgba(251, 191, 36, 0.6)); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .flash-gold {
            animation: goldPulse 0.4s ease-out;
            color: #f59e0b !important; /* Ensure it stays gold */
        }

        .mood-btn.active {
            transform: scale(1.2);
            background-color: rgba(255,255,255,0.9);
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .mood-btn {
            opacity: 0.8;
            transition: all 0.3s;
            filter: grayscale(0); 
        }
        .mood-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        @keyframes magicPulse {
            0% { border-color: #e3ebe3; }
            50% { border-color: #9bb99b; }
            100% { border-color: #e3ebe3; }
        }
        .manifest-btn {
            animation: magicPulse 3s infinite ease-in-out;
            border: 1px dashed #c5d8c5;
        }

        [contenteditable]:focus {
            outline: none;
            background-color: rgba(255,255,255,0.5);
            border-bottom: 1px solid #a8a29e;
        }
        
        [contenteditable]:empty:before {
            content: attr(placeholder);
            color: #d6d3d1;
            font-style: italic;
            display: block; 
        }

        .bare-input {
            background: transparent;
            border: none;
            border-bottom: 1px dashed #d6d3d1;
            font-family: inherit;
            color: #57534e;
            outline: none;
            transition: border-color 0.2s;
        }
        .bare-input:focus {
            border-bottom: 1px solid #a8a29e;
        }

        .project-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .project-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .project-scroll::-webkit-scrollbar-thumb {
            background-color: #d6d3d1;
            border-radius: 20px;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex justify-center pb-32 text-base">

    <div class="max-w-md w-full space-y-6">
        
        <!-- Header -->
        <header class="text-center pt-8 space-y-2">
            <h1 class="text-xl font-light text-stone-600 tracking-[0.3em] uppercase">Inner Garden</h1>
            <p class="text-sm text-stone-400 font-light tracking-widest">NN's Life OS</p>
            <p id="dateDisplay" class="text-xs text-stone-300 font-mono tracking-wide mt-1"></p>
        </header>

        <!-- Sticky Points Bar -->
        <div class="sticky top-6 z-40 transition-transform duration-300" id="pointsBar">
            <div class="glass-card bg-white/90 px-6 py-4 flex justify-between items-center shadow-sm border-stone-100">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-stone-400"></div>
                    <span class="text-xs text-stone-500 font-normal uppercase tracking-widest">Energy</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-baseline gap-1">
                        <!-- Points Color Changed to Amber (Gold) -->
                        <span class="text-3xl font-normal text-amber-500 font-mono transition-colors" id="totalPoints">0</span>
                        <span class="text-xs text-stone-400">pts</span>
                    </div>
                    <!-- Reset Button -->
                    <button onclick="resetPoints()" class="p-1.5 rounded-full hover:bg-stone-100 text-stone-300 hover:text-red-400 transition-colors" title="é‡ç½®ç§¯åˆ†">
                        <i data-lucide="rotate-ccw" class="w-3.5 h-3.5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 1. è€•è€˜åŒºåŸŸ (Growth) -->
        <section class="space-y-4">
            <div class="flex items-center justify-between px-2">
                <div class="flex items-center gap-2">
                    <i data-lucide="sprout" class="w-4 h-4 text-stone-400"></i>
                    <h2 class="text-xs font-bold text-stone-400 uppercase tracking-widest">Growth</h2>
                </div>
            </div>
            
            <!-- Dynamic Projects List (Fixed, No Drag) -->
            <div id="projects-container" class="space-y-4">
                <!-- Projects injected here -->
            </div>

            <!-- Add Project Button -->
            <button onclick="openProjectModal()" class="w-full py-3 rounded-xl border border-dashed border-stone-300 text-stone-400 text-sm hover:border-sage-400 hover:text-sage-500 hover:bg-white/50 transition-all flex items-center justify-center gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i>
                <span>æ·»åŠ æ–°çš„é•¿æœŸä»»åŠ¡</span>
            </button>

            <!-- Hobbies (Dynamic List with Drag) -->
            <div class="glass-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-stone-600 font-normal text-sm">æ¯æ—¥é¢å¤–å…´è¶£åŠ åˆ†</span>
                    <span class="bg-stone-100 text-stone-500 text-xs px-2 py-0.5 rounded-full">+20</span>
                </div>
                <!-- Hobby List -->
                <div class="space-y-3" id="list-hobbies">
                    <!-- Injected by JS -->
                </div>
                <!-- Add Hobby Button -->
                <button onclick="addHobbyTask()" class="mt-4 w-full py-2 rounded-lg border border-dashed border-stone-200 text-xs text-stone-400 hover:text-sage-500 hover:border-sage-300 transition-all flex items-center justify-center gap-1 group">
                    <i data-lucide="plus" class="w-3 h-3 group-hover:scale-110 transition-transform"></i>
                    æ·»åŠ å…´è¶£é¡¹
                </button>
            </div>

            <!-- Customizable Habits (Block Style with Drag) -->
            <div id="habits-container" class="space-y-4">
                <!-- Dynamic Habits injected here -->
            </div>

            <!-- Add Habit Button -->
            <button onclick="addHabit()" class="w-full py-3 rounded-xl border border-dashed border-stone-300 text-stone-400 text-sm hover:border-sage-400 hover:text-sage-500 hover:bg-white/50 transition-all flex items-center justify-center gap-2">
                <i data-lucide="plus-square" class="w-4 h-4"></i>
                <span>æ·»åŠ æ¯æ—¥æ‰“å¡</span>
            </button>
        </section>

        <!-- 2. è¥å…»ä¸ç³–åˆ† (Nourish) -->
        <section class="space-y-4 pt-4">
            <div class="flex items-center gap-2 px-2">
                <i data-lucide="utensils" class="w-4 h-4 text-stone-400"></i>
                <h2 class="text-xs font-bold text-stone-400 uppercase tracking-widest">Nourish</h2>
            </div>

            <!-- Nutrition Grid (Now Dynamic) -->
            <div id="nutrition-grid" class="grid grid-cols-4 gap-3">
                <!-- Injected by JS -->
            </div>

            <!-- Sugar Quota (Chocolate) -->
            <div class="glass-card p-6 bg-white/60">
                <div class="flex justify-between items-start mb-5">
                    <div>
                        <h3 class="font-normal text-sm text-stone-600">ç³–åˆ†é¢åº¦</h3>
                        <p class="text-xs text-stone-400 mt-1">å‰©ä½™ç»“ç®— <span class="text-sage-500 font-medium">+50 pts/é¢—</span></p>
                    </div>
                </div>
                
                <div class="flex justify-between px-2 gap-2">
                    <div class="relative w-12 h-12 flex items-center justify-center cursor-pointer transition-all duration-300 hover:scale-110" onclick="consumeSugar(0)" id="sugar-btn-0">
                        <span class="text-3xl filter drop-shadow-sm">ğŸ«</span>
                    </div>
                    <div class="relative w-12 h-12 flex items-center justify-center cursor-pointer transition-all duration-300 hover:scale-110" onclick="consumeSugar(1)" id="sugar-btn-1">
                        <span class="text-3xl filter drop-shadow-sm">ğŸ«</span>
                    </div>
                    <div class="relative w-12 h-12 flex items-center justify-center cursor-pointer transition-all duration-300 hover:scale-110" onclick="consumeSugar(2)" id="sugar-btn-2">
                        <span class="text-3xl filter drop-shadow-sm">ğŸ«</span>
                    </div>
                    <div class="relative w-12 h-12 flex items-center justify-center cursor-pointer transition-all duration-300 hover:scale-110" onclick="consumeSugar(3)" id="sugar-btn-3">
                        <span class="text-3xl filter drop-shadow-sm">ğŸ«</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. æ‰‹æœºä¸æˆ’æ–­ (Detox) -->
        <section class="space-y-4 pt-4">
            <div class="flex items-center gap-2 px-2">
                <i data-lucide="smartphone-off" class="w-4 h-4 text-stone-400"></i>
                <h2 class="text-xs font-bold text-stone-400 uppercase tracking-widest">Detox</h2>
            </div>
            
            <div class="glass-card p-6 space-y-6">
                <!-- Xiaohongshu -->
                <div>
                    <div class="flex justify-between mb-3">
                        <span class="text-sm text-stone-500">å°çº¢ä¹¦ <span class="text-xs text-stone-300 ml-1">&lt;2h æ¬¡æ—¥+50</span></span>
                        <span id="xhsVal" class="text-sm font-mono text-sage-500">1h</span>
                    </div>
                    <input type="range" min="0" max="6" step="0.5" value="1" id="xhsSlider" oninput="updatePhone('xhs', this.value)" class="w-full block">
                </div>

                <!-- Taobao -->
                <div>
                    <div class="flex justify-between mb-3">
                        <span class="text-sm text-stone-500">æ·˜å®/è´­ç‰© <span class="text-xs text-stone-300 ml-1">&lt;2h æ¬¡æ—¥+50</span></span>
                        <span id="taobaoVal" class="text-sm font-mono text-sage-500">1h</span>
                    </div>
                    <input type="range" min="0" max="6" step="0.5" value="1" id="taobaoSlider" oninput="updatePhone('taobao', this.value)" class="w-full block">
                </div>
            </div>
        </section>

        <!-- 4. æ¬²æœ›å¸‚é›† (Market) -->
        <section class="space-y-4 pt-4">
            <div class="flex items-center justify-between px-2">
                <div class="flex items-center gap-2">
                    <i data-lucide="gift" class="w-4 h-4 text-stone-400"></i>
                    <h2 class="text-xs font-bold text-stone-400 uppercase tracking-widest">Market</h2>
                </div>
                <!-- NEW: Market Reset Button -->
                <button onclick="resetMarket()" class="text-stone-300 hover:text-red-400 transition-colors p-1" title="é‡ç½®æ„¿æœ›æ¸…å•">
                    <i data-lucide="rotate-ccw" class="w-3.5 h-3.5"></i>
                </button>
            </div>

            <!-- Ritual Button -->
            <div id="ritual-container" class="hidden">
                <button onclick="startRitual()" class="w-full h-16 glass-card manifest-btn flex items-center justify-center gap-2 text-sage-600 font-normal tracking-wider hover:bg-white/80 transition-colors">
                    <i data-lucide="stars" class="w-5 h-5 opacity-50"></i>
                    <span class="text-sm">è®¸ä¸ªæ„¿æœ›å§ï¼</span>
                </button>
            </div>

            <!-- Market List -->
            <div id="market-list" class="space-y-4">
                <!-- Tier 1 -->
                <div class="glass-card p-5 hidden border-l-4 border-stone-200" id="card-light">
                    <div id="reward-slot-light" class="flex justify-between items-center"></div>
                </div>
                <!-- Tier 2 -->
                <div class="glass-card p-5 hidden border-l-4 border-stone-300" id="card-medium">
                    <div id="reward-slot-medium" class="flex justify-between items-center"></div>
                </div>
                <!-- Tier 3 -->
                <div class="glass-card p-5 hidden border-l-4 border-stone-400" id="card-heavy">
                    <div id="reward-slot-heavy" class="flex justify-between items-center"></div>
                </div>
            </div>
        </section>

        <!-- Mood & Sleep -->
        <section class="pt-8 pb-8 space-y-6">
             <div class="glass-card p-5 flex justify-between items-center px-6">
                <button onclick="setMood(1)" class="mood-btn text-2xl" title="ç„¦è™‘/ä½è½">ğŸŒ§ï¸</button>
                <button onclick="setMood(2)" class="mood-btn text-2xl" title="ç–²æƒ«">â˜ï¸</button>
                <button onclick="setMood(3)" class="mood-btn text-2xl" title="å¹³é™">ğŸŒ±</button>
                <button onclick="setMood(4)" class="mood-btn text-2xl" title="æ„‰æ‚¦">â˜€ï¸</button>
                <button onclick="setMood(5)" class="mood-btn text-2xl" title="èƒ½é‡çˆ†æ£š">âœ¨</button>
            </div>

            <button onclick="sleepMode()" class="w-full py-5 rounded-xl bg-stone-600 text-stone-100 shadow-lg hover:bg-stone-700 active:scale-95 transition-all flex items-center justify-center gap-2">
                <i data-lucide="moon" class="w-5 h-5"></i>
                <span class="tracking-widest font-light text-sm">æ™šå®‰ç»“ç®—</span>
            </button>
        </section>

    </div>

    <!-- Project Creation Modal -->
    <div id="projectModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-stone-200/50 backdrop-blur-sm" onclick="closeProjectModal()"></div>
        <div class="glass-card bg-white p-8 max-w-sm w-full relative z-10 animate-pop border border-stone-100 shadow-xl max-h-[85vh] overflow-y-auto project-scroll">
            <div class="text-center mb-6">
                <i data-lucide="map" class="w-8 h-8 text-stone-400 mx-auto mb-2"></i>
                <h3 class="text-base font-normal text-stone-600 tracking-widest uppercase">å¼€å¯æ–°çš„èˆªè¡Œ</h3>
                <p class="text-xs text-stone-400 mt-1">å®šä¹‰ç»ˆç‚¹ï¼Œç„¶åæ‹†è§£è·¯å¾„</p>
            </div>
            
            <div class="space-y-5">
                <!-- Main Info -->
                <div class="space-y-3">
                    <label class="text-xs text-stone-400 font-bold block uppercase tracking-wide">é¡¹ç›®åç§°</label>
                    <input type="text" id="new-proj-title" placeholder="å¦‚: Essay, Presentation..." class="w-full py-2 border-b border-stone-200 bg-transparent text-stone-600 text-sm focus:border-sage-400 focus:outline-none placeholder-stone-300 transition-colors">
                </div>
                
                <div class="space-y-3">
                    <label class="text-xs text-stone-400 font-bold block uppercase tracking-wide">æˆªæ­¢æ—¥æœŸ</label>
                    <input type="date" id="new-proj-ddl" class="w-full py-2 border-b border-stone-200 bg-transparent text-stone-600 text-sm focus:border-sage-400 focus:outline-none">
                </div>

                <!-- Breakdown -->
                <div class="pt-4 border-t border-stone-50">
                    <label class="text-xs text-sage-500 font-bold block uppercase tracking-wide mb-3">ä»»åŠ¡æ‹†è§£</label>
                    <div class="space-y-3" id="new-proj-steps">
                        <!-- Dynamic Inputs injected here -->
                    </div>
                    <!-- Add Step Button -->
                    <button onclick="addProjectStepInput()" class="mt-3 text-xs text-stone-400 hover:text-sage-500 flex items-center gap-1 transition-colors">
                        <i data-lucide="plus" class="w-3 h-3"></i> æ·»åŠ æ­¥éª¤
                    </button>
                </div>
            </div>

            <div class="flex justify-end gap-4 mt-8 pt-4 border-t border-stone-100">
                <button onclick="closeProjectModal()" class="text-stone-400 text-sm hover:text-stone-600 transition-colors">å–æ¶ˆ</button>
                <button onclick="addNewProject()" class="px-6 py-2 bg-stone-600 text-white rounded-xl text-sm font-normal tracking-wide shadow-md hover:bg-stone-700 transition-all">ç¡®è®¤å¯èˆª</button>
            </div>
        </div>
    </div>

    <!-- Ritual/Edit Modal -->
    <div id="ritualModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-stone-200/50 backdrop-blur-sm" onclick="closeRitualModal()"></div>
        <div class="glass-card bg-white p-8 max-w-sm w-full relative z-10 animate-pop border border-stone-100">
            <div class="text-center mb-8">
                <i data-lucide="sparkles" class="w-6 h-6 text-stone-400 mx-auto mb-3"></i>
                <h3 class="text-sm font-normal text-stone-600 tracking-widest uppercase">è®¸æ„¿æ¸…å•</h3>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="text-xs text-stone-400 font-bold mb-1 block uppercase tracking-wide">Level 1 Â· å°ç¡®å¹¸ 300</label>
                    <input type="text" id="input-light" placeholder="å¤§çº¦éœ€ç§¯ç´¯ 1 å¤©..." class="w-full py-2 border-b border-stone-200 bg-transparent text-stone-600 text-sm focus:border-stone-400 focus:outline-none placeholder-stone-300 transition-colors">
                </div>
                <div>
                    <label class="text-xs text-stone-400 font-bold mb-1 block uppercase tracking-wide">Level 2 Â· ä¸­çº§å¿«ä¹ 1000</label>
                    <input type="text" id="input-medium" placeholder="å¤§çº¦éœ€ç§¯ç´¯ 3-4 å¤©..." class="w-full py-2 border-b border-stone-200 bg-transparent text-stone-600 text-sm focus:border-stone-400 focus:outline-none placeholder-stone-300 transition-colors">
                </div>
                <div>
                    <label class="text-xs text-stone-400 font-bold mb-1 block uppercase tracking-wide">Level 3 Â· ç»ˆææ„¿æœ› 2500</label>
                    <input type="text" id="input-heavy" placeholder="å¤§çº¦éœ€ç§¯ç´¯ 1 å‘¨..." class="w-full py-2 border-b border-stone-200 bg-transparent text-stone-600 text-sm focus:border-stone-400 focus:outline-none placeholder-stone-300 transition-colors">
                </div>
            </div>

            <div class="flex justify-end gap-4 mt-8">
                <button onclick="closeRitualModal()" class="text-stone-400 text-sm hover:text-stone-600 transition-colors">å–æ¶ˆ</button>
                <button onclick="saveRitual()" class="px-6 py-2 bg-stone-600 text-white rounded-xl text-sm font-normal tracking-wide shadow-md hover:bg-stone-700 transition-all">ä¿å­˜æ„¿æœ›</button>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="msgModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-stone-200/50 backdrop-blur-sm" onclick="closeMsgModal()"></div>
        <div class="glass-card bg-white p-8 max-w-sm w-full relative z-10 animate-pop text-center border border-stone-100">
            <div id="modalIcon" class="text-4xl mb-4">âœ¨</div>
            <h3 id="modalTitle" class="text-base font-bold text-stone-600 mb-3 tracking-wide"></h3>
            <p id="modalBody" class="text-stone-500 text-sm leading-loose mb-8 font-light"></p>
            <button onclick="closeMsgModal()" class="px-6 py-2 rounded-full border border-stone-300 text-stone-500 text-sm hover:bg-stone-50 hover:text-stone-700 transition-all">
                å¥½çš„ï¼ŒNN çŸ¥é“äº†
            </button>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const REWARD_TIERS = {
            light: { cost: 300 },
            medium: { cost: 1000 },
            heavy: { cost: 2500 }
        };

        const todayStr = new Date().toDateString();

        // --- State ---
        let state = {
            points: 0,
            date: todayStr,
            lastMonth: new Date().getMonth(), // Track month for resets
            projects: [], 
            growth: {
                // Hobbies remain as a list
                hobbies: { tasks: [""], done: [false] },
                // Reading moved here + user can add more
                habits: [
                    { id: 'reading', title: "Reading", score: 30, done: false, monthlyCount: 0 },
                    { id: 'exercise', title: "Exercise", score: 30, done: false, monthlyCount: 0 }
                ]
            },
            // Nourish now tracks checked status instead of infinite points
            nutrition: { protein: false, veggie: false, fat: false, fruit: false },
            sugarConsumed: [false, false, false, false], 
            phone: { xhs: 1, taobao: 1 },
            rewards: { light: null, medium: null, heavy: null },
            mood: 0
        };

        // --- SortableJS Initialization ---
        let sortables = [];

        function initSortable() {
            // Destroy existing instances if any (for re-render safety)
            sortables.forEach(s => s.destroy());
            sortables = [];

            // 1. Habits Sortable
            const habitsContainer = document.getElementById('habits-container');
            if (habitsContainer) {
                const s1 = Sortable.create(habitsContainer, {
                    animation: 150,
                    handle: '.drag-handle', // use the grip icon
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onStart: function() {
                        document.body.classList.add('dragging');
                    },
                    onEnd: function (evt) {
                        document.body.classList.remove('dragging');
                        // Reorder state array
                        const item = state.growth.habits.splice(evt.oldIndex, 1)[0];
                        state.growth.habits.splice(evt.newIndex, 0, item);
                        saveState();
                    }
                });
                sortables.push(s1);
            }

            // 2. Hobbies List Sortable
            const hobbiesList = document.getElementById('list-hobbies');
            if (hobbiesList) {
                const s2 = Sortable.create(hobbiesList, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onStart: function() {
                        document.body.classList.add('dragging');
                    },
                    onEnd: function (evt) {
                        document.body.classList.remove('dragging');
                        // Reorder both tasks and done arrays
                        const task = state.growth.hobbies.tasks.splice(evt.oldIndex, 1)[0];
                        state.growth.hobbies.tasks.splice(evt.newIndex, 0, task);
                        
                        const done = state.growth.hobbies.done.splice(evt.oldIndex, 1)[0];
                        state.growth.hobbies.done.splice(evt.newIndex, 0, done);
                        
                        saveState();
                    }
                });
                sortables.push(s2);
            }
        }

        // --- Initialization ---
        function init() {
            lucide.createIcons();
            document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('zh-CN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            loadState();
            checkNewDay();
            render();
        }

        function loadState() {
            const saved = localStorage.getItem('inner_garden_state_v8_nn');
            if (saved) {
                const parsed = JSON.parse(saved);
                
                // --- Migration Logic ---
                // If old version had reading boolean but no habits array
                if (typeof parsed.growth.reading === 'boolean' && !parsed.growth.habits) {
                    parsed.growth.habits = [
                        { id: 'reading', title: "Reading", score: 30, done: parsed.growth.reading, monthlyCount: 0 }
                    ];
                    delete parsed.growth.reading; // remove old key
                }

                state = { ...state, ...parsed };

                // Ensure data integrity
                if (!state.growth.hobbies || !Array.isArray(state.growth.hobbies.tasks)) {
                    state.growth.hobbies = { tasks: [""], done: [false] };
                }
                if (!state.growth.habits) {
                    state.growth.habits = [{ id: 'reading', title: "Reading", score: 30, done: false, monthlyCount: 0 }];
                }

                // Ensure monthlyCount exists for all habits
                state.growth.habits.forEach(h => {
                    if (typeof h.monthlyCount === 'undefined') h.monthlyCount = 0;
                    
                    // RENAME LOGIC: Update old default names to new simple names
                    if (h.title === "é™è°§é˜…è¯» (Reading)") h.title = "Reading";
                    if (h.title === "æ´»åŠ›è¿åŠ¨ (Exercise)") h.title = "Exercise";
                });
                
                // Ensure Exercise exists (Migration for this update)
                // Check for various forms of exercise title to avoid duplicates
                const hasExercise = state.growth.habits.some(h => h.title === 'Exercise' || h.title === 'æ´»åŠ›è¿åŠ¨ (Exercise)' || h.id === 'exercise');
                if (!hasExercise) {
                    state.growth.habits.push({ id: 'exercise', title: "Exercise", score: 30, done: false, monthlyCount: 0 });
                }

                // Ensure nutrition object exists
                if (!state.nutrition) {
                    state.nutrition = { protein: false, veggie: false, fat: false, fruit: false };
                }
                
                // Initialize lastMonth if missing
                if (typeof state.lastMonth === 'undefined') {
                    state.lastMonth = new Date().getMonth();
                }
            }
        }

        function saveState() {
            localStorage.setItem('inner_garden_state_v8_nn', JSON.stringify(state));
        }

        function checkNewDay() {
            const currentMonth = new Date().getMonth();
            
            // Check for new month reset FIRST
            if (state.lastMonth !== currentMonth) {
                state.lastMonth = currentMonth;
                // Reset monthly counts
                state.growth.habits.forEach(h => h.monthlyCount = 0);
                showModal("æ–°çš„ä¸€æœˆ", "æ–°çš„æœˆä»½å¼€å§‹äº†ï¼Œæ‰€æœ‰æ‰“å¡è®¡æ•°å·²å½’é›¶ã€‚<br>æ„¿æœ¬æœˆäº¦æœ‰æ‰€è·ã€‚", "ğŸ“…");
            }

            if (state.date !== todayStr) {
                let bonus = 0;
                let report = [];

                // Sugar Bonus
                const sugarsKept = state.sugarConsumed.filter(x => !x).length;
                if (sugarsKept > 0) {
                    const sugarBonus = sugarsKept * 50;
                    bonus += sugarBonus;
                    report.push(`ğŸ¬ ç³–åˆ†æ§åˆ¶: +${sugarBonus}`);
                }

                // Phone Bonus
                if (state.phone.xhs < 2) {
                    bonus += 50;
                    report.push(`ğŸ“± å°çº¢ä¹¦æˆ’æ–­: +50`);
                }
                if (state.phone.taobao < 2) {
                    bonus += 50;
                    report.push(`ğŸ›ï¸ æ·˜å®æˆ’æ–­: +50`);
                }

                if (bonus > 0) {
                    state.points += bonus;
                    setTimeout(() => {
                        showModal("æ—©å®‰ï¼ŒNN", `æ–°çš„ä¸€å¤©å¼€å§‹äº†ã€‚<br>æ˜¨æ—¥çš„å›é¦ˆå·²é€è¾¾ï¼š<br><br>${report.join('<br>')}<br><br>æ€»è®¡: <b>+${bonus} PTS</b>`, "ğŸ");
                    }, 1000);
                }

                // Reset Logic 
                state.date = todayStr;
                
                // Reset hobbies
                state.growth.hobbies.done = state.growth.hobbies.done.map(() => false);
                
                // Reset habits (daily blocks) but keep titles/ids
                state.growth.habits.forEach(h => h.done = false);

                // Reset nutrition
                state.nutrition = { protein: false, veggie: false, fat: false, fruit: false };
                
                state.sugarConsumed = [false, false, false, false];
                state.phone = { xhs: 0, taobao: 0 }; 
                state.mood = 0;
                
                saveState();
                render(); // explicit render after new day check
            }
        }

        // --- Rendering ---
        function render() {
            document.getElementById('totalPoints').innerText = state.points;
            
            // 1. Projects
            renderProjects();

            // 2. Daily Growth
            renderGrowthList('hobbies', 'list-hobbies');
            renderHabits(); 

            // 3. Nutrition (Dynamic Render)
            renderNutrition();

            // 4. Render Sugar
            state.sugarConsumed.forEach((eaten, i) => {
                const btn = document.getElementById(`sugar-btn-${i}`);
                if (eaten) {
                    btn.innerHTML = ''; 
                    btn.classList.add('opacity-0', 'pointer-events-none');
                } else {
                    btn.innerHTML = '<span class="text-3xl filter drop-shadow-sm">ğŸ«</span>';
                    btn.classList.remove('opacity-0', 'pointer-events-none');
                }
            });

            // 5. Render Phone
            document.getElementById('xhsSlider').value = state.phone.xhs;
            document.getElementById('xhsVal').innerText = state.phone.xhs + 'h';
            updatePhoneColor('xhsVal', state.phone.xhs);
            document.getElementById('taobaoSlider').value = state.phone.taobao;
            document.getElementById('taobaoVal').innerText = state.phone.taobao + 'h';
            updatePhoneColor('taobaoVal', state.phone.taobao);

            // 6. Render Market
            renderMarket();

            // 7. Mood
            document.querySelectorAll('.mood-btn').forEach((btn, i) => {
                if (i + 1 === state.mood) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            lucide.createIcons();
            
            // Re-initialize Sortable after DOM update
            initSortable();
        }

        // --- Projects Render ---
        function renderProjects() {
            const container = document.getElementById('projects-container');
            container.innerHTML = '';

            state.projects.forEach((proj, pIndex) => {
                const projCard = document.createElement('div');
                projCard.className = "glass-card p-6 relative group mb-4";
                
                let tasksHtml = '';
                proj.tasks.forEach((taskName, tIndex) => {
                    if(!taskName) return; 

                    const isDone = proj.done[tIndex];
                    tasksHtml += `
                        <div class="flex items-center gap-3 group/task">
                            <div onclick="toggleProjectTask(${pIndex}, ${tIndex})" class="w-4 h-4 rounded-full border ${isDone ? 'border-stone-500 bg-stone-500' : 'border-stone-300'} flex items-center justify-center cursor-pointer transition-colors flex-shrink-0">
                                ${isDone ? '<i data-lucide="check" class="w-2.5 h-2.5 text-white"></i>' : ''}
                            </div>
                            <span class="text-sm ${isDone ? 'text-stone-400 line-through opacity-70' : 'text-stone-600'} flex-1 py-1">${taskName}</span>
                        </div>
                    `;
                });

                projCard.innerHTML = `
                    <div class="mb-4 space-y-1">
                        <div class="flex justify-between items-start">
                            <h3 class="text-stone-600 font-medium text-base">${proj.title || "æœªå‘½åé¡¹ç›®"}</h3>
                            <button onclick="deleteProject(${pIndex})" class="text-stone-200 hover:text-red-300 transition-colors p-1"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-stone-400">
                            <i data-lucide="calendar" class="w-3 h-3"></i>
                            <span>DDL: ${proj.ddl || "æ— "}</span>
                        </div>
                    </div>
                    <div class="space-y-3 pl-1">
                        ${tasksHtml || '<p class="text-xs text-stone-300 italic">æš‚æ— å­ä»»åŠ¡</p>'}
                    </div>
                `;
                container.appendChild(projCard);
            });
        }

        // --- Growth Render ---
        function renderGrowthList(cat, elementId) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            
            // Hobbies are now dynamic
            state.growth[cat].tasks.forEach((taskName, i) => {
                const isDone = state.growth[cat].done[i];
                const row = document.createElement('div');
                row.className = "flex items-center gap-3 group";
                row.innerHTML = `
                    <div class="drag-handle cursor-grab text-stone-300 hover:text-stone-500 p-1 flex-shrink-0">
                         <i data-lucide="grip-vertical" class="w-3 h-3"></i>
                    </div>
                    <div onclick="toggleGrowthTask('${cat}', ${i})" class="w-4 h-4 rounded-full border ${isDone ? 'border-sage-500 bg-sage-500' : 'border-stone-300'} flex items-center justify-center cursor-pointer transition-colors flex-shrink-0">
                        ${isDone ? '<i data-lucide="check" class="w-2.5 h-2.5 text-white"></i>' : ''}
                    </div>
                    <span contenteditable="true" placeholder="ç‚¹å‡»æ·»åŠ ..." onblur="saveGrowthTaskName('${cat}', ${i}, this.innerText)" class="text-sm ${isDone ? 'text-sage-500 line-through opacity-70' : 'text-stone-600'} outline-none flex-1 border-b border-transparent hover:border-stone-200 transition-colors py-1">${taskName}</span>
                    <button onclick="deleteHobbyTask(${i})" class="opacity-0 group-hover:opacity-100 text-stone-300 hover:text-red-300 transition-opacity p-1">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                `;
                container.appendChild(row);
            });
        }

        function renderHabits() {
            const container = document.getElementById('habits-container');
            container.innerHTML = '';

            state.growth.habits.forEach((habit, index) => {
                const habitDiv = document.createElement('div');
                habitDiv.className = "glass-card p-6 relative group";
                
                // Drag handle icon for Habits
                const dragHandle = `
                    <div class="drag-handle absolute top-6 left-2 cursor-grab text-stone-300 hover:text-stone-500 p-2 z-10">
                        <i data-lucide="grip-vertical" class="w-4 h-4"></i>
                    </div>
                `;
                
                // Monthly Count Badge
                const countBadge = `
                    <div class="flex items-center gap-1 text-xs text-stone-400 font-mono bg-stone-100 px-2 py-0.5 rounded-full" title="æœ¬æœˆç´¯è®¡æ‰“å¡">
                        <i data-lucide="calendar" class="w-3 h-3"></i>
                        ${habit.monthlyCount}
                    </div>
                `;

                // Content for the block
                let content = '';
                if (habit.done) {
                    content = `
                        <div class="flex justify-between items-center mb-4 pl-6"> 
                            <span contenteditable="true" onblur="saveHabitTitle(${index}, this.innerText)" class="text-stone-600 font-normal text-sm outline-none border-b border-transparent hover:border-stone-200 transition-colors">${habit.title}</span>
                            <div class="flex items-center gap-2">
                                ${countBadge}
                                <span class="bg-sage-100 text-sage-600 text-xs px-2 py-0.5 rounded-full">+${habit.score}</span>
                            </div>
                        </div>
                        <button onclick="toggleHabit(${index})" id="habit-btn-${index}" class="w-full h-14 rounded-xl border border-sage-200 bg-sage-50 flex items-center justify-center gap-2 transition-all">
                            <i data-lucide="check" class="w-5 h-5 text-sage-600"></i>
                            <span class="text-sm text-sage-600 font-normal">ä»Šæ—¥å·²å®Œæˆ</span>
                        </button>
                    `;
                } else {
                    content = `
                        <div class="flex justify-between items-center mb-4 pl-6">
                            <span contenteditable="true" onblur="saveHabitTitle(${index}, this.innerText)" class="text-stone-600 font-normal text-sm outline-none border-b border-transparent hover:border-stone-200 transition-colors">${habit.title}</span>
                            <div class="flex items-center gap-2">
                                ${countBadge}
                                <span class="bg-stone-100 text-stone-500 text-xs px-2 py-0.5 rounded-full">+${habit.score}</span>
                            </div>
                        </div>
                        <button onclick="toggleHabit(${index})" id="habit-btn-${index}" class="w-full h-14 rounded-xl border border-stone-200 bg-stone-50/50 flex items-center justify-center gap-2 transition-all hover:bg-white hover:border-stone-300 group">
                            <i data-lucide="book-open" class="w-5 h-5 text-stone-400 group-hover:text-stone-500 transition-colors"></i>
                            <span class="text-sm text-stone-400 group-hover:text-stone-500 tracking-wide">è®°å½•ä»Šæ—¥</span>
                        </button>
                    `;
                }

                habitDiv.innerHTML = `
                    ${dragHandle}
                    <button onclick="deleteHabit(${index})" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-stone-200 hover:text-red-300 transition-all p-1 z-10">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                    ${content}
                `;
                container.appendChild(habitDiv);
            });
        }

        // --- Render Nutrition (New) ---
        function renderNutrition() {
            const container = document.getElementById('nutrition-grid');
            container.innerHTML = '';

            const items = [
                { key: 'protein', icon: 'ğŸ¥š', label: 'è›‹ç™½è´¨', color: 'orange' },
                { key: 'veggie', icon: 'ğŸ¥¬', label: 'è”¬èœ', color: 'green' },
                { key: 'fat', icon: 'ğŸ¥‘', label: 'ä¼˜è´¨æ²¹', color: 'amber' },
                { key: 'fruit', icon: 'ğŸ’', label: 'æ°´æœ', color: 'rose' }
            ];

            items.forEach(item => {
                const isChecked = state.nutrition[item.key];
                
                // Base classes
                let classes = "glass-card p-4 flex flex-col items-center gap-2 active:scale-95 transition-all group border";
                
                if (isChecked) {
                    // é€‰ä¸­çŠ¶æ€ï¼š
                    // èƒŒæ™¯ï¼šå›ºå®šä¸ºå¯¹åº”é¢œè‰²çš„æµ…è‰²èƒŒæ™¯ (ä¾‹å¦‚ bg-orange-50)
                    // è¾¹æ¡†ï¼šä¸ºäº†æŸ”å’Œï¼Œä½¿ç”¨ææµ…çš„åŒè‰²è¾¹æ¡† (ä¾‹å¦‚ border-orange-100)
                    classes += ` bg-${item.color}-50 border-${item.color}-100`; 
                } else {
                    // æœªé€‰ä¸­çŠ¶æ€
                    classes += ` border-white/60 hover:bg-${item.color}-50/50`;
                }

                const btn = document.createElement('button');
                btn.className = classes;
                btn.onclick = () => toggleNutrition(item.key);
                
                // æ–‡æœ¬é¢œè‰²é€»è¾‘
                const textClass = isChecked ? `text-${item.color}-600 font-medium` : `text-stone-500 group-hover:text-${item.color}-600`;

                // ç§»é™¤å‹¾é€‰ç¬¦å·ï¼Œä»…ä¿ç•™å›¾æ ‡å’Œæ–‡å­—
                btn.innerHTML = `
                    <span class="text-xl ${isChecked ? 'scale-110' : ''} transition-transform">${item.icon}</span>
                    <span class="text-xs ${textClass} transition-colors">
                        ${item.label}
                    </span>
                `;
                container.appendChild(btn);
            });
        }

        function renderMarket() {
            const hasEmptySlot = !state.rewards.light || !state.rewards.medium || !state.rewards.heavy;
            const ritualBtn = document.getElementById('ritual-container');
            
            if (hasEmptySlot) {
                ritualBtn.classList.remove('hidden');
            } else {
                ritualBtn.classList.add('hidden');
            }

            renderRewardCard('light');
            renderRewardCard('medium');
            renderRewardCard('heavy');
        }

        function renderRewardCard(tier) {
            const card = document.getElementById(`card-${tier}`);
            const slot = document.getElementById(`reward-slot-${tier}`);
            const rewardName = state.rewards[tier];
            const config = REWARD_TIERS[tier];

            if (rewardName) {
                card.classList.remove('hidden');
                const canAfford = state.points >= config.cost;
                slot.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden w-full">
                        <button onclick="editReward('${tier}')" class="text-stone-300 hover:text-stone-500 transition-colors flex-shrink-0">
                            <i data-lucide="pencil" class="w-3 h-3"></i>
                        </button>
                        <span class="text-stone-600 font-normal text-sm truncate flex-1">${rewardName}</span>
                        <button onclick="redeemReward('${tier}')" class="px-4 py-1.5 rounded-lg text-xs tracking-wide transition-all whitespace-nowrap flex-shrink-0 ${canAfford ? 'bg-sage-500 text-white hover:bg-sage-600 shadow-sm' : 'bg-stone-100 text-stone-400 cursor-not-allowed'}">
                            å…‘æ¢
                        </button>
                    </div>
                `;
            } else {
                card.classList.add('hidden'); 
            }
        }

        function updatePhoneColor(id, val) {
            const el = document.getElementById(id);
            if (val < 2) el.className = "text-sm font-mono text-sage-500";
            else if (val < 4) el.className = "text-sm font-mono text-stone-400";
            else el.className = "text-sm font-mono text-stone-400"; 
        }

        // --- Interaction Logic ---

        // NEW: Reset Points
        function resetPoints() {
            if(confirm("ç¡®å®šè¦å°†æ‰€æœ‰ç§¯åˆ†æ¸…é›¶å¹¶é‡ç½®ä»Šæ—¥æ‰“å¡çŠ¶æ€å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚")) {
                // 1. Reset Points
                state.points = 0;

                // 2. Reset Project Tasks
                state.projects.forEach(p => {
                    p.done.fill(false);
                });

                // 3. Reset Hobbies
                state.growth.hobbies.done.fill(false);

                // 4. Reset Habits (Smart Reset)
                state.growth.habits.forEach(h => {
                    if(h.done) {
                        // If resetting a done habit, we must decrement the count
                        // because the user effectively "un-did" it.
                        // If they do it again today, it will increment back up.
                        h.monthlyCount = Math.max(0, (h.monthlyCount || 0) - 1);
                        h.done = false;
                    }
                });

                // 5. Reset Nutrition
                state.nutrition = { protein: false, veggie: false, fat: false, fruit: false };

                // 6. Reset Sugar
                state.sugarConsumed = [false, false, false, false];

                // 7. Reset Phone (Optional, but makes sense for a full reset)
                state.phone = { xhs: 0, taobao: 0 };

                // 8. Reset Mood
                state.mood = 0;

                saveState();
                render();
                showModal("é‡ç½®æˆåŠŸ", "ç§¯åˆ†å·²å½’é›¶ï¼Œä»Šæ—¥æ‰“å¡çŠ¶æ€å·²é‡ç½®ã€‚<br>GOGOGO!", "ğŸŒ±");
            }
        }

        // NEW: Reset Market
        function resetMarket() {
            if(confirm("ç¡®å®šè¦æ¸…ç©ºå½“å‰çš„æ„¿æœ›æ¸…å•å—ï¼Ÿ")) {
                state.rewards = { light: null, medium: null, heavy: null };
                saveState();
                render();
            }
        }

        // Project Modal & Logic
        function openProjectModal() {
            document.getElementById('new-proj-title').value = "";
            document.getElementById('new-proj-ddl').value = "";
            
            // Reset steps: clear previous and add one initial empty input
            const container = document.getElementById('new-proj-steps');
            container.innerHTML = '';
            addProjectStepInput();
            
            document.getElementById('projectModal').classList.remove('hidden');
        }

        function addProjectStepInput(value = "") {
            const container = document.getElementById('new-proj-steps');
            const wrapper = document.createElement('div');
            wrapper.className = "flex items-center gap-2 group";
            
            // We need unique placeholder based on count, but simple is fine
            const count = container.children.length + 1;
            
            wrapper.innerHTML = `
                <input type="text" value="${value}" placeholder="æ­¥éª¤ ${count}..." class="flex-1 py-2 border-b border-stone-100 bg-transparent text-stone-500 text-sm focus:border-stone-300 focus:outline-none placeholder-stone-200">
                <button onclick="this.parentElement.remove()" class="text-stone-200 hover:text-red-300 opacity-0 group-hover:opacity-100 transition-opacity p-1">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            `;
            container.appendChild(wrapper);
            lucide.createIcons();
            
            // Auto-focus the new input if it's empty (newly added)
            const input = wrapper.querySelector('input');
            if(!value && input) input.focus();
        }

        function closeProjectModal() {
            document.getElementById('projectModal').classList.add('hidden');
        }

        function addNewProject() {
            const title = document.getElementById('new-proj-title').value.trim();
            const ddl = document.getElementById('new-proj-ddl').value;
            
            // Gather non-empty steps from the dynamic inputs
            const tasks = [];
            document.getElementById('new-proj-steps').querySelectorAll('input').forEach(input => {
                const val = input.value.trim();
                if(val) tasks.push(val);
            });

            if(!title) {
                alert("è¯·è‡³å°‘è¾“å…¥é¡¹ç›®åç§°");
                return;
            }

            state.projects.push({
                id: Date.now(),
                title: title,
                ddl: ddl,
                tasks: tasks,
                done: new Array(tasks.length).fill(false)
            });

            saveState();
            closeProjectModal();
            render(); 
        }

        function deleteProject(index) {
            if(confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ")) {
                state.projects.splice(index, 1);
                saveState();
                render(); // re-render
            }
        }

        function toggleProjectTask(projIndex, taskIndex) {
            const proj = state.projects[projIndex];
            const isDone = proj.done[taskIndex];
            
            if (!isDone) {
                proj.done[taskIndex] = true;
                addPoints(20, event.currentTarget);
            } else {
                proj.done[taskIndex] = false;
                addPoints(-20, event.currentTarget);
            }
            saveState();
        }

        // Hobbies Dynamic Logic
        function addHobbyTask() {
            state.growth.hobbies.tasks.push("");
            state.growth.hobbies.done.push(false);
            saveState();
            render(); // re-render
        }

        function deleteHobbyTask(index) {
            // Optional: confirm if it has text
            if (state.growth.hobbies.tasks[index] && !confirm("ç¡®å®šè¦åˆ é™¤è¿™é¡¹å…´è¶£å—ï¼Ÿ")) return;
            
            state.growth.hobbies.tasks.splice(index, 1);
            state.growth.hobbies.done.splice(index, 1);
            saveState();
            render(); // re-render
        }

        function saveGrowthTaskName(cat, index, val) {
            state.growth[cat].tasks[index] = val.trim();
            saveState();
        }

        function toggleGrowthTask(cat, index) {
            const isDone = state.growth[cat].done[index];
            state.growth[cat].done[index] = !isDone;
            addPoints(isDone ? -20 : 20, event.currentTarget);
            saveState();
        }

        // Habits Logic
        function addHabit() {
            state.growth.habits.push({
                id: Date.now(),
                title: "æ–°ä¹ æƒ¯",
                score: 30,
                done: false,
                monthlyCount: 0
            });
            saveState();
            render(); // re-render
        }

        function deleteHabit(index) {
            if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹ æƒ¯æ‰“å¡å—ï¼Ÿ")) {
                state.growth.habits.splice(index, 1);
                saveState();
                render(); // re-render
            }
        }

        function saveHabitTitle(index, val) {
            state.growth.habits[index].title = val.trim();
            saveState();
        }

        function toggleHabit(index) {
            const habit = state.growth.habits[index];
            const wasDone = habit.done;
            habit.done = !wasDone;
            
            // Monthly Count Logic
            if (!wasDone) {
                // Done
                habit.monthlyCount = (habit.monthlyCount || 0) + 1;
            } else {
                // Undo
                habit.monthlyCount = Math.max(0, (habit.monthlyCount || 0) - 1);
            }

            const btn = document.getElementById(`habit-btn-${index}`);
            addPoints(habit.done ? habit.score : -habit.score, btn);
            saveState();
            render(); // re-render to update count UI
        }


        // Sugar
        function consumeSugar(index) {
            if (state.sugarConsumed[index]) return;
            if (confirm("NN, ç¡®å®šè¦æ¶ˆè€—è¿™ä»½ç³–åˆ†é¢åº¦å—ï¼Ÿå¦‚æœå¿ä½åˆ°æ˜å¤© +50 PTSã€‚")) {
                state.sugarConsumed[index] = true;
                saveState();
                render(); // re-render
            }
        }

        // Nutrition Logic (New Toggle)
        function toggleNutrition(type) {
            // Initialize if undefined (for old saves)
            if (state.nutrition[type] === undefined) state.nutrition[type] = false;
            
            const isChecked = state.nutrition[type];
            state.nutrition[type] = !isChecked;
            
            // Add or subtract points
            const btn = event.currentTarget; // This might capture the wrong element if not careful, but render binds it
            addPoints(!isChecked ? 50 : -50, btn); // Pass the button for float animation
            
            saveState();
        }

        function updatePhone(type, val) {
            state.phone[type] = parseFloat(val);
            render();
            clearTimeout(window.phoneSaveTimeout);
            window.phoneSaveTimeout = setTimeout(saveState, 1000);
        }

        function startRitual() {
            document.getElementById('input-light').value = state.rewards.light || "";
            document.getElementById('input-medium').value = state.rewards.medium || "";
            document.getElementById('input-heavy').value = state.rewards.heavy || "";
            document.getElementById('ritualModal').classList.remove('hidden');
        }

        function editReward(tier) {
            startRitual(); // Reuse the same modal
        }

        function closeRitualModal() {
            document.getElementById('ritualModal').classList.add('hidden');
        }

        function saveRitual() {
            const light = document.getElementById('input-light').value.trim();
            const medium = document.getElementById('input-medium').value.trim();
            const heavy = document.getElementById('input-heavy').value.trim();

            if (light) state.rewards.light = light;
            if (medium) state.rewards.medium = medium;
            if (heavy) state.rewards.heavy = heavy;

            saveState();
            closeRitualModal();
            showModal("æ„¿æœ›å·²ç¡®è®¤", "NN, æ„¿æœ›å·²æ›´æ–°ã€‚<br>ç”¨æ—¥å¸¸çš„ç§©åºå»æµ‡çŒå®ƒä»¬å§ã€‚", "âœ¨");
            render(); // re-render
        }

        function redeemReward(tier) {
            const cost = REWARD_TIERS[tier].cost;
            const name = state.rewards[tier];
            if (state.points >= cost) {
                if (confirm(`ç¡®å®šæ¶ˆè€— ${cost} PTS å…‘æ¢ "${name}" å—ï¼Ÿ`)) {
                    state.points -= cost;
                    state.rewards[tier] = null; // Clear slot
                    saveState();
                    render(); // re-render
                    showModal("å…‘æ¢æˆåŠŸ", `NN, ä½ å·²è·å¾—: <b>${name}</b><br>è¯·å°½æƒ…äº«å—è¿™ä»½å¥–èµã€‚<br>éšåå¯ä»¥å¼€å¯æ–°çš„è®¸æ„¿ã€‚`, "ğŸ");
                }
            }
        }

        function addPoints(amount, element) {
            state.points += amount;
            
            // Floating point animation
            if (element) {
                const floatEl = document.createElement('div');
                floatEl.innerText = amount > 0 ? `+${amount}` : amount;
                floatEl.className = `point-float ${amount < 0 ? 'point-deduct' : ''}`;
                const rect = element.getBoundingClientRect();
                floatEl.style.left = (rect.left + rect.width / 2 - 10) + 'px';
                floatEl.style.top = (rect.top) + 'px';
                document.body.appendChild(floatEl);
                setTimeout(() => floatEl.remove(), 1000);
            }
            
            const totalEl = document.getElementById('totalPoints');
            // Animation logic
            totalEl.classList.remove('flash-gold');
            void totalEl.offsetWidth; // trigger reflow
            totalEl.classList.add('flash-gold');
            
            render();
        }

        function setMood(m) {
            state.mood = m;
            saveState();
            render(); // re-render to highlight mood
        }

        // --- AI Summary Logic (Refined for Flow) ---
        function generateReport() {
            // 1. Data Analysis
            let tasksDone = 0;
            state.projects.forEach(p => {
                p.done.forEach(d => { if(d) tasksDone++ });
            });
            state.growth.hobbies.done.forEach(d => { if(d) tasksDone++ });
            state.growth.habits.forEach(h => { if(h.done) tasksDone++ });
            
            let nutriCount = 0;
            Object.values(state.nutrition).forEach(v => { if(v) nutriCount++ });

            const sugarKept = state.sugarConsumed.filter(x => !x).length;

            // 2. Construct Narrative Parts
            const parts = [];

            // Part A: Greeting (Removed as per request)

            // Part B: Growth (Garden Metaphor)
            let growthText = "";
            if (tasksDone >= 5) {
                growthText = "ä»Šå¤©ä½ çš„èŠ±å›­é‡Œç”Ÿæœºå‹ƒå‹ƒã€‚æ— è®ºæ˜¯æ¨è¿›é•¿æœŸé¡¹ç›®è¿˜æ˜¯åšæŒæ—¥å¸¸ä¹ æƒ¯ï¼Œä½ éƒ½æŠ•å…¥äº†å¤§é‡çš„ç²¾åŠ›ï¼Œè¿™ä»½å……å®æ„Ÿæ˜¯æ—¶é—´ç»™ä½ çš„å›é¦ˆã€‚";
            } else if (tasksDone >= 1) {
                growthText = "ä»Šå¤©ä½ æŒ‰ç…§è‡ªå·±çš„èŠ‚å¥åœ¨è€•è€˜ï¼Œç§ä¸‹äº†ä¸€äº›ç§å­ã€‚ä¸æ€¥ä¸èºï¼Œä¿æŒæ­¥è°ƒï¼Œè¿™æ ·å¾ˆå¥½ã€‚";
            } else {
                growthText = "ä»Šå¤©æ˜¯ä¼‘å…»ç”Ÿæ¯çš„ä¸€å¤©ã€‚åœŸåœ°åœ¨é™é»˜ä¸­ç§¯è“„å…»åˆ†ï¼Œä½ ä¹Ÿæ˜¯ã€‚å…è®¸è‡ªå·±åœä¸‹æ¥ï¼Œæ˜¯ä¸ºäº†æ›´å¥½åœ°å‡ºå‘ã€‚";
            }

            // Specific Habits Highlight
            const doneHabits = state.growth.habits.filter(h => h.done);
            if (doneHabits.length > 0) {
                const names = doneHabits.map(h => h.title).join('ã€');
                growthText += ` ç‰¹åˆ«å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä½ å®Œæˆäº† ${names}ã€‚åšæŒæœ¬èº«å°±æ˜¯ä¸€ç§é—ªé—ªå‘å…‰çš„èƒ½åŠ›ã€‚`;
            }
            parts.push(growthText);

            // Part C: Body & Nourishment
            let bodyHighlights = [];
            if (nutriCount >= 3) bodyHighlights.push("æ‘„å…¥äº†ä¸°å¯Œçš„è¥å…»");
            
            if (sugarKept === 4) {
                bodyHighlights.push("å°çŒ«å®Œç¾åœ°æ§åˆ¶äº†ç³–åˆ†ï¼Œè¿™æ ·çš„è‡ªæ§åŠ›éå¸¸è¿·äºº^ ^");
            } else if (sugarKept >= 2) {
                bodyHighlights.push("ä¸é”™åœ°æ§åˆ¶äº†ç³–åˆ†ï¼Œå·§å…‹åŠ›è®©å°çŒ«å¼€å¿ƒ");
            }

            if (bodyHighlights.length > 0) {
                parts.push(`åœ¨èº«ä½“ç…§é¡¾æ–¹é¢ï¼Œ${bodyHighlights.join("ï¼ŒåŒæ—¶")}ã€‚`);
            } else if (tasksDone > 0) {
                // Only generic reminder if nothing specific achieved in body section
                parts.push("åœ¨å¿™ç¢Œä¹‹ä½™ï¼Œä¹Ÿè¯·è®°å¾—å¤šå…³ç…§ä¸€ä¸‹èº«ä½“çš„éœ€æ±‚ã€‚");
            }

            // Part D: Mood & Emotional Check-in
            let moodText = "";
            if (state.mood === 1) {
                moodText = "å®è´ï¼Œä»Šå¤©ä¸å¼€å¿ƒå—ï¼Ÿæ‰¾CèŠèŠå§";
            } else if (state.mood === 2) {
                moodText = "ä»Šå¤©çœ‹èµ·æ¥å¾ˆç´¯ï¼Œè¾›è‹¦äº†ã€‚å¥½å¥½ç¡ä¸€è§‰ï¼Œæ˜å¤©ä¼šæ˜¯æ–°çš„ä¸€å¤©ã€‚";
            } else if (state.mood === 3) {
                moodText = "å†…å¿ƒå¹³é™æ˜¯å¾ˆéš¾å¾—çš„åŠ›é‡ï¼Œæ„¿ä½ ç»§ç»­ä¿æŒè¿™ä»½ä»å®¹ã€‚";
            } else if (state.mood === 4) {
                moodText = "å¾ˆé«˜å…´çœ‹åˆ°ä½ ä»Šå¤©å¿ƒæƒ…ä¸é”™ï¼Œå¸Œæœ›è¿™ä»½å¿«ä¹èƒ½å»¶ç»­è¿›æ¢¦é‡Œã€‚";
            } else if (state.mood === 5) {
                moodText = "ä»Šå¤©çŠ¶æ€æ»¡åˆ†ï¼å¤ªæ£’äº†ï¼Œå€¼å¾—è®°å½•ä¸‹ä»Šå¤©ï¼";
            }
            if (moodText) parts.push(moodText);

            // Part E: Closing
            parts.push("æ•°æ®å·²ä¿å­˜ã€‚æ™šå®‰ã€‚");

            // Combine with spacing
            return parts.join("<br><br>");
        }

        function sleepMode() {
            const summary = generateReport();
            showModal("âœ¨ ä»Šæ—¥æ€»ç»“", summary, "ğŸŒ™");
        }

        function showModal(title, body, icon) {
            document.getElementById('modalTitle').innerHTML = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modalIcon').innerText = icon;
            document.getElementById('msgModal').classList.remove('hidden');
        }

        function closeMsgModal() {
            document.getElementById('msgModal').classList.add('hidden');
        }

        init();
    </script>
</body>
</html>
